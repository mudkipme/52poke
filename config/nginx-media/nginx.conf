worker_processes  auto;

error_log  /var/log/nginx/error.log  crit;
load_module /usr/lib/nginx/modules/ngx_http_cache_purge_module.so;

events {
    worker_connections  4096;
}

worker_rlimit_nofile 8192;

http {
    include       mime.types;
    default_type  application/octet-stream;
    set_real_ip_from 10.0.0.0/8;

    log_format rt_cache '$remote_addr - $host $upstream_cache_status [$time_local] '
    	                '"$request" $status $body_bytes_sent '
    	                '"$http_referer" "$http_user_agent" "$http_x_forwarded_for"';

    sendfile        on;
    keepalive_timeout  65;

    gzip  on;
    gzip_proxied any;
    gzip_types text/css application/x-javascript text/plain text/xml application/xml application/xhtml+xml text/vnd.wap.wml application/javascript application/json text/javascript image/svg+xml;

    client_max_body_size 16M;

    proxy_cache_path /var/cache/nginx/media levels=2:2 keys_zone=media:128m inactive=10d max_size=15360m;
    proxy_temp_path /var/cache/nginx/proxy;

    server {
        listen   80;
        access_log /var/log/nginx/access.log rt_cache;
        server_name  media.52poke.com assets.52poke.com static.52poke.com media.52poke.net s0.52poke.wiki;

        valid_referers none blocked 52poke.com *.52poke.com 52poke.wiki *.52poke.wiki 52poke.net *.52poke.net;
        if ($invalid_referer) {
            return 403;
        }
%{ for bad_ua in media_ban_user_agent ~}
        if ($http_user_agent ~ "${bad_ua}") {
            return 403;
        }
%{ endfor ~}
%{ for uri in media_ban_empty_refer_uri ~}
        if ($uri ~ "${uri}") {
            set $validtest A;
        }
%{ endfor ~}
        if ($http_referer = "") {
            set $validtest "$${validtest}B";
        }
        if ($validtest = AB) {
            return 403;
        }
        location / {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET;
            proxy_pass http://media.52poke.com.s3-website-ap-northeast-1.amazonaws.com;
            proxy_redirect     off;
            proxy_set_header   Host "media.52poke.com";
            proxy_pass_header  Server;
            proxy_cache        media;
            proxy_cache_key    media.52poke.com$uri$is_args$args;
            proxy_cache_valid  200 4w;
            proxy_max_temp_file_size 8192m;
            expires 4w;
            proxy_cache_purge PURGE from 10.0.0.0/8;
        }

        location ~ ^/wiki/thumb/(archive/)?[0-9a-f]/[0-9a-f][0-9a-f]/([^/]+)/([0-9]+)px-.*$ {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET;
            proxy_pass http://media.52poke.com.s3-website-ap-northeast-1.amazonaws.com;
            proxy_redirect     off;
            proxy_set_header   Host "media.52poke.com";
            proxy_pass_header  Server;
            proxy_cache        media;
            proxy_cache_key    media.52poke.com$uri$is_args$args;
            proxy_cache_valid  200 4w;
            proxy_max_temp_file_size 8192m;
            proxy_intercept_errors on;
            expires 4w;
            error_page     404 502 504 = @thumb;
            proxy_cache_purge PURGE from 10.0.0.0/8;
        }

        location @thumb {
            internal;
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET;
            proxy_pass         https://${malasada_api_id}.execute-api.ap-northeast-1.amazonaws.com/prod$request_uri;
            proxy_ssl_server_name on;
            proxy_pass_header  Server;
            proxy_cache        media;
            proxy_cache_key    media.52poke.com$uri$is_args$args;
            proxy_cache_valid  200 4w;
            proxy_max_temp_file_size 8192m;
            expires 4w;
        }

        location ~ ^/gallery/ {
            return 301         https://legacy.52poke.net$request_uri;
        }

        location ~ ^/wiki/deleted/ {
            deny all;
        }
    }

    server {
        listen 80;
        server_name s1.52poke.wiki;

        valid_referers none blocked 52poke.com *.52poke.com 52poke.wiki *.52poke.wiki 52poke.net *.52poke.net;
        if ($invalid_referer) {
            return 403;
        }

        location / {
            proxy_redirect off;
            proxy_set_header Host media.52poke.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forward-For $proxy_add_x_forwarded_for;
            proxy_pass http://127.0.0.1;
        }

        location ~ \.(jpg|jpeg|png)$ {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET;
            proxy_pass http://media.52poke.com.s3-website-ap-northeast-1.amazonaws.com/webp-cache$request_uri;
            proxy_redirect     off;
            proxy_set_header   Host "media.52poke.com";
            proxy_pass_header  Server;
            proxy_intercept_errors on;
            proxy_cache        media;
            proxy_cache_key    media.52poke.com/webp-cache$uri$is_args$args;
            proxy_cache_valid  200 4w;
            expires 4w;
            error_page     404 502 504 = @webp;
            break;
        }

        location @webp {
            internal;
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods GET;
            proxy_pass https://${malasada_api_id}.execute-api.ap-northeast-1.amazonaws.com/prod/webp$request_uri;
            proxy_ssl_server_name on;
            proxy_pass_header  Server;
            proxy_cache        media;
            proxy_cache_key    media.52poke.com/webp-cache$uri$is_args$args;
            proxy_cache_valid  200 4w;
            expires 4w;
        }
    }
}